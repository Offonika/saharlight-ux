import{j as e,u as F,a as H,b as $}from"./index-DQBQ-MfV.js";import{r as d,u as z,f as B,g as K}from"./vendor-CzhASIQC.js";import"./switch-D0WL0-E9.js";import{M as I}from"./MedicalButton-BhCwfXK3.js";import{a as V,u as q,c as A}from"./reminders-LgkAEGZj.js";import"./authFetch-Dy4ehdii.js";const Y=({open:m,onClose:p,side:l="bottom",children:a})=>{const w=d.useRef(null),f=d.useRef(null),s=d.useRef(null);d.useEffect(()=>{var h,y;if(!m)return;const i=(h=f.current)==null?void 0:h.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'),v=i==null?void 0:i[0],u=i==null?void 0:i[i.length-1],g=r=>{r.key==="Escape"?p():r.key==="Tab"&&i&&i.length&&(r.shiftKey?document.activeElement===v&&(r.preventDefault(),u==null||u.focus()):document.activeElement===u&&(r.preventDefault(),v==null||v.focus()))};s.current=document.activeElement;const o=document.body.style.overflow;return document.body.style.overflow="hidden",document.addEventListener("keydown",g),(y=v||f.current)==null||y.focus(),()=>{var r;document.body.style.overflow=o,document.removeEventListener("keydown",g),(r=s.current)==null||r.focus()}},[m,p]);const S=b=>{b.target===w.current&&p()};if(!m)return null;const x=l==="top"?"top-0 left-0 w-full":l==="left"?"left-0 top-0 h-full w-64":l==="right"?"right-0 top-0 h-full w-64":"bottom-0 left-0 w-full";return e.jsx("div",{ref:w,onMouseDown:S,className:"fixed inset-0 z-50 bg-overlay",children:e.jsx("div",{ref:f,tabIndex:-1,onMouseDown:b=>b.stopPropagation(),className:`absolute bg-card shadow-[var(--shadow-soft)] outline-none ${x}`,children:a})})},G=m=>m==="meds"?"medicine":m,N={sugar:{label:"–°–∞—Ö–∞—Ä",emoji:"ü©∏"},insulin:{label:"–ò–Ω—Å—É–ª–∏–Ω",emoji:"üíâ"},meal:{label:"–ü—Ä–∏—ë–º –ø–∏—â–∏",emoji:"üçΩÔ∏è"},medicine:{label:"–õ–µ–∫–∞—Ä—Å—Ç–≤–∞",emoji:"üíä"}},J={sugar:[15,30,60],insulin:[120,180,240],meal:[180,240,360],medicine:[240,480,720]};function Q(m){const[p,l]=m.split(":").map(Number);return Number.isInteger(p)&&Number.isInteger(l)&&p>=0&&p<=23&&l>=0&&l<=59}function te(){const m=z(),p=B(),l=K(),{user:a,sendData:w}=F(),{toast:f}=H(),[s,S]=d.useState(p.state??void 0),[x,b]=d.useState((s==null?void 0:s.type)??"sugar"),[i,v]=d.useState((s==null?void 0:s.title)??""),[u,g]=d.useState((s==null?void 0:s.time)??""),[o,h]=d.useState((s==null?void 0:s.interval)??60),[y,r]=d.useState(null),[C,R]=d.useState(!1);d.useEffect(()=>{!s&&l.id&&(a!=null&&a.id)&&(async()=>{try{const t=await V(a.id,Number(l.id));if(t){const n=G(t.type),c={id:t.id??Number(l.id),type:n,title:t.title??N[n].label,time:t.time||"",interval:t.intervalHours!=null?t.intervalHours*60:void 0};S(c),b(c.type),v(c.title),g(c.time),h(c.interval??60)}else{const n="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ";r(n),f({title:"–û—à–∏–±–∫–∞",description:n,variant:"destructive"})}}catch(t){const n=t instanceof Error?t.message:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ";r(n),f({title:"–û—à–∏–±–∫–∞",description:n,variant:"destructive"})}})()},[s,l.id,a==null?void 0:a.id,f]);const D=i.trim().length>=2,L=Q(u),M=typeof o=="number"&&o>=5,k=D&&L&&M,O=async t=>{if(t.preventDefault(),!k||!(a!=null&&a.id))return;r(null);const n={telegramId:a.id,type:x,time:u,intervalHours:o!=null?o/60:void 0,isEnabled:!0,...s?{id:s.id}:{}};try{const c=s?await q(n):await A(n),j=s?s.id:c==null?void 0:c.id,T=o!=null?o/60:void 0,P=T!=null&&Number.isInteger(T)?`${T}h`:u;j&&w({id:j,type:x,value:P}),m("/reminders")}catch(c){const j=c instanceof Error?c.message:"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ";r(j),f({title:"–û—à–∏–±–∫–∞",description:j,variant:"destructive"})}},E=N[x];return e.jsxs("form",{onSubmit:O,className:"pb-24 space-y-4",children:[y&&e.jsx("div",{className:"mb-4 text-destructive",children:y}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:"–¢–∏–ø"}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 px-3 py-1.5 rounded-full border bg-secondary text-sm",onClick:()=>R(!0),children:[e.jsx("span",{children:E.emoji}),e.jsx("span",{children:E.label})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",children:"–ù–∞–∑–≤–∞–Ω–∏–µ"}),e.jsx("input",{id:"title",className:"input",value:i,onChange:t=>v(t.target.value),maxLength:40})]}),e.jsxs("div",{className:"grid gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"time",children:"–í—Ä–µ–º—è"}),e.jsx("input",{id:"time",className:"input",type:"time",value:u,onChange:t=>g(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"interval",children:"–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω)"}),e.jsx("input",{id:"interval",className:"input",type:"number",min:5,step:5,value:o??"",onChange:t=>{const n=parseInt(t.target.value,10);h(Number.isNaN(n)?void 0:n)}}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:J[x].map(t=>e.jsx("button",{type:"button",onClick:()=>h(t),className:$("px-3 py-1 rounded-full border text-sm",o===t&&"bg-primary text-primary-foreground border-primary"),children:t},t))})]})]}),e.jsx(Y,{open:C,onClose:()=>R(!1),children:e.jsx("div",{className:"p-4 grid grid-cols-3 gap-4",children:Object.keys(N).map(t=>e.jsxs("button",{type:"button",onClick:()=>{b(t),R(!1)},className:"flex flex-col items-center justify-center p-4 rounded-lg border",children:[e.jsx("span",{className:"text-2xl",children:N[t].emoji}),e.jsx("span",{className:"mt-2 text-sm",children:N[t].label})]},t))})}),e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 border-t bg-background p-4 flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{children:[E.emoji," "]}),i.trim()||E.label,", ",u,o&&` ‚Ä¢ –∫–∞–∂–¥—ã–µ ${o} –º–∏–Ω`]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{type:"button",variant:"secondary",onClick:()=>m("/reminders"),children:"–û—Ç–º–µ–Ω–∞"}),e.jsx(I,{type:"submit",disabled:!k,children:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"})]})]})]})}export{te as default};
