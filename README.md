# Diabetes Bot

## –û–ø–∏—Å–∞–Ω–∏–µ
–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –¥–ª—è –ø–æ–º–æ—â–∏ –¥–∏–∞–±–µ—Ç–∏–∫–∞–º 2 —Ç–∏–ø–∞:
- üì∑ –†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –µ–¥—É –ø–æ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ GPT-4o
- ü•ó –°—á–∏—Ç–∞–µ—Ç —É–≥–ª–µ–≤–æ–¥—ã –∏ –•–ï
- üíâ (–≤ –±—É–¥—É—â–µ–º) –ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–∑—É –∏–Ω—Å—É–ª–∏–Ω–∞
- üìí –í–µ–¥—ë—Ç –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è –∏ —Å–∞—Ö–∞—Ä–∞

–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ PostgreSQL (—Ç–∞–±–ª–∏—Ü–∞ `history_records`). –ú–∏–≥—Ä–∞—Ü–∏–∏ –ª–µ–∂–∞—Ç –≤ `services/api/alembic/`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- `services/` ‚Äî –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - `api/` ‚Äî FastAPI‚Äë—Å–µ—Ä–≤–µ—Ä –∏ —Ç–µ–ª–µ–≥—Ä–∞–º‚Äë–±–æ—Ç (`services/api/app/diabetes/` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç)
  - `bot/`, `worker/`, `clinic-panel/` ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
  - `webapp/` ‚Äî React‚ÄëSPA (`services/webapp/ui` ‚Äî –∏—Å—Ö–æ–¥–Ω–∏–∫–∏, —Å–±–æ—Ä–∫–∞ –≤ `services/webapp/ui/dist/`)
- `libs/` ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ SDK
- `infra/` ‚Äî –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`infra/env/.env.example` ‚Äî –ø—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
- `docs/` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—Å–º. `docs/README.md`)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
git clone https://github.com/Offonika/saharlight-ux.git
cd saharlight-ux
python3.12 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install -r services/api/app/requirements-dev.txt
corepack enable || npm install -g pnpm
pnpm install
pnpm --filter services/webapp/ui run build
cp infra/env/.env.example .env
```
–ó–∞–ø–æ–ª–Ω–∏—Ç–µ `.env` —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

## –ú–∏–≥—Ä–∞—Ü–∏–∏

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –º–∏–≥—Ä–∞—Ü–∏–π —Å–æ–∑–¥–∞–π—Ç–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:

```bash
python3.12 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
make migrate
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `diabetes_sdk`
–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–µ–º—É API –Ω—É–∂–µ–Ω –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –ø–∞–∫–µ—Ç `diabetes_sdk`.
–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø —É –º–µ–π–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```bash
# —á–µ—Ä–µ–∑ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
pip install git+https://github.com/Offonika/diabetes_sdk.git

# –ª–∏–±–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏ SDK
pip install -r libs/py-sdk/requirements.txt
pip install -e libs/py-sdk
```
–ï—Å–ª–∏ SDK –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, —Ç—Ä–µ–±—É—é—â–∞—è –≤–Ω–µ—à–Ω–µ–≥–æ API, –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.

## –ó–∞–ø—É—Å–∫ API
```bash
uvicorn services.api.app.main:app --host 0.0.0.0 --port 8000
```

## –ó–∞–ø—É—Å–∫ –ë–æ—Ç–∞
```bash
scripts/run_bot.sh
```
–°–∫—Ä–∏–ø—Ç –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç `.env` –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `services.api.app.bot`.

### –ö–æ–º–∞–Ω–¥—ã BotFather

–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ BotFather:

```
/trial - –í–∫–ª—é—á–∏—Ç—å trial
/upgrade - –û—Ñ–æ—Ä–º–∏—Ç—å PRO
```

## –û–Ω–±–æ—Ä–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ WebApp
–ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ WebApp. –û—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
`timezone.html` –∏ –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ WebApp
–ø–æ—Å–ª–µ `/start`.

### –ü—Ä–∏–º–µ—Ä `/start`
```bash
curl -X POST http://localhost:8000/api/onboarding/events \
  -H 'Content-Type: application/json' \
  -H 'X-Telegram-Init-Data: <init-data>' \
  -d '{"event":"onboarding_started","step":0}'
```

### –ü—Ä–∏–º–µ—Ä `/status`
```bash
curl -H 'X-Telegram-Init-Data: <init-data>' \
  http://localhost:8000/api/onboarding/status
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ `X-Telegram-Init-Data` –≤ WebApp
–í–Ω—É—Ç—Ä–∏ Telegram¬†Web¬†App –¥–æ—Å—Ç—É–ø –∫ —Ç–æ–∫–µ–Ω—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç
`Telegram.WebApp`. –ï–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
`X-Telegram-Init-Data` –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API:

```ts
const tg = window.Telegram.WebApp;
tg.ready();
const initData = tg.initData;

fetch('http://localhost:8000/api/onboarding/status', {
  headers: { 'X-Telegram-Init-Data': initData },
});
```

### –°–æ–±—ã—Ç–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- `onboarding_started` ‚Äî WebApp –æ—Ç–∫—Ä—ã—Ç –≤ —Ä–µ–∂–∏–º–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞;
- `profile_saved` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –≤–∞–ª–∏–¥–µ–Ω;
- `first_reminder_created` ‚Äî —Å–æ–∑–¥–∞–Ω–æ –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ;
- `onboarding_completed` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å—Ç–∏–ª
  –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `skippedReminders: true`).

–û–Ω–±–æ—Ä–¥–∏–Ω–≥ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º, –∫–æ–≥–¥–∞ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ
–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ `onboarding_completed` —Å `skippedReminders`.

## –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º
–ü–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –ø—Ä–æ—Ñ–∏–ª—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å —á–µ—Ä–µ–∑ REST¬†API.

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
```bash
curl -X POST http://localhost:8000/api/profile \
  -H 'Content-Type: application/json' \
  -d '{"telegramId":777,"icr":1.0,"cf":1.0,"target":5.0,"low":4.0,"high":6.0}'
```
–û—Ç–≤–µ—Ç:
```json
{"status": "ok"}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
```bash
curl http://localhost:8000/api/profile?telegramId=777
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ `.env`:
- `TELEGRAM_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ);
- `PUBLIC_ORIGIN` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π URL API;
- `WEBAPP_URL` ‚Äî –∞–¥—Ä–µ—Å WebApp –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞;
- `API_URL` ‚Äî –±–∞–∑–æ–≤—ã–π URL –≤–Ω–µ—à–Ω–µ–≥–æ API; —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç `diabetes_sdk`;
- `OPENAI_API_KEY` ‚Äî –∫–ª—é—á OpenAI –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. `infra/env/.env.example`.

## –ü–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
–ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å.
–°—ã—Ä—ã–µ —Ç–µ–∫—Å—Ç—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è: —Ç–∞–±–ª–∏—Ü—ã `assistant_memory` –∏
`lesson_logs` —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–∏—à—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å—á—ë—Ç—á–∏–∫–∏, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏, —à–∞–≥–∏).

## –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤
–§–∏–∫—Å—Ç—É—Ä–∞ `lessons_v0.json` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —É—á–µ–±–Ω—ã–µ —É—Ä–æ–∫–∏.
–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Ö –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
make load-lessons
```

–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –æ–±—É—á–µ–Ω–∏—è.
–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (`make migrate`) –∏
–Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `DATABASE_URL` –ª–∏–±–æ `DB_HOST`/`DB_PORT`/`DB_NAME`/
`DB_USER`/`DB_PASSWORD`.

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–æ–≤ –∏ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–∫—Å—Ç—É—Ä
1. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ `lessons_v0.json`, —Å–æ–±–ª—é–¥–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç.
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `make load-lessons`, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É.
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∏–∫—Å—Ç—É—Ä—É: `python scripts/load_lessons.py --dump lessons_v0.json`.

## –¢–µ—Å—Ç—ã
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
pip install -r services/api/app/requirements-dev.txt
pytest tests/
mypy --strict .
ruff check .
```
