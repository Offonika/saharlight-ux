# 005 — Split insulin doses for diary entries

> [← Назад к оглавлению документации](../README.md)

- **Status:** Proposed
- **Date:** 2025-02-21
- **Owner:** Backend Guild

## Context
- Пользователи в дневнике фиксируют болюсный (короткий) и базальный (длинный) инсулин. В текущей схеме хранится единое поле `dose`,
  что создаёт неопределённость: нельзя отличить тип дозы и корректно строить аналитические отчёты.
- Новые UI‑формы, экспорт и отчётность требуют явных полей для каждого типа инсулина.
- На бэкенде уже накоплены записи с `dose`, поэтому миграция должна быть обратной совместимой.

## Decision
- Добавляем в модель записи дневника два отдельных поля `insulin_short` и `insulin_long` (числовой тип с точностью до десятых).
- API и парсинг входящих данных принимают оба поля. При одновременной передаче `dose` и новых полей приоритет получают
  `insulin_short` / `insulin_long`, `dose` игнорируется.
- При передаче только `dose` сервер трактует значение как `insulin_short` и заполняет оба поля в ответе, обеспечивая безопасность
  для старых клиентов.
- Поле `dose` объявляется устаревшим и будет удалено в релизе v3.0 (ориентировочно 2026‑03‑01) после перехода всех клиентов.

### Data schema & parsing
- БД: добавляются nullable‑колонки `insulin_short` и `insulin_long` в таблицу записей; `dose` остаётся до финального удаления.
- Валидация допускает значения от `0.0` до `200.0` с шагом `0.5`. Нулевые значения трактуются как «не указано» и хранятся как `NULL`.
- Конвертация входящих запросов:
  - если отправлены `insulin_short` или `insulin_long`, они сохраняются напрямую;
  - если отправлено только `dose`, оно маппится в `insulin_short`;
  - смешанные сценарии логируются как предупреждение для телеметрии (см. [metrics](../observability/split-insulin-doses-metrics.md)).

## Rollout plan
1. Миграция и инструкции по БД описаны в [docs/MIGRATIONS.md](../MIGRATIONS.md).
2. Командам фронтенда и контента следовать гайдлайнам в
   [docs/content/style/insulin-doses-copy.md](../content/style/insulin-doses-copy.md).
3. API документировано в [docs/api/entries.md](../api/entries.md) — использовать новые поля в формах и SDK.
4. Отчётность и BI‑дашборды обновляются по правилам [docs/reporting/insulin-doses-rendering.md](../reporting/insulin-doses-rendering.md).
5. QA покрывает новые сценарии согласно [docs/qa/split-insulin-doses-testplan.md](../qa/split-insulin-doses-testplan.md).
6. Мониторинг и алёрты описаны в [docs/observability/split-insulin-doses-metrics.md](../observability/split-insulin-doses-metrics.md).

## Consequences
- Отчёты и экспорты получают достоверные данные по типам инсулина без ручного разбиения.
- Клиентские приложения должны обновить формы, однако легаси-флоу остаётся рабочим до удаления `dose`.
- Требуется дополнительное обучение саппорта и контент-команды (см. гайд по копирайтингу) для единообразной терминологии.

## Follow-up
- Создать задачу на удаление поля `dose` после завершения мониторинга — не раньше, чем через два релизных цикла после v3.0.
- Перевести все ETL и BI-пайплайны на использование новых полей, отказавшись от `dose` как запасного варианта.
