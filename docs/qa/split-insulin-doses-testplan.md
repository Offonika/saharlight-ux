# Тест-план: разделённые дозы инсулина

## Цели
Убедиться, что дневник и API корректно работают с отдельными полями `insulin_short` и `insulin_long`, а сценарии с легаси-полем `dose`
обрабатываются без потери данных.

## Матрица тестовых сценариев
| ID | Тип данных | Вход | Ожидаемый результат |
|----|------------|------|---------------------|
| TP-01 | Только короткий | `insulin_short=4.5` | Ответ содержит `insulin_short=4.5`, `insulin_long=null`, UI показывает «короткий» |
| TP-02 | Только длинный | `insulin_long=8` | Ответ содержит `insulin_long=8`, `insulin_short=null` |
| TP-03 | Оба поля | `insulin_short=3`, `insulin_long=12` | Оба значения сохраняются и отображаются раздельно |
| TP-04 | Легаси поле | `dose=6` | Ответ содержит `insulin_short=6`, `insulin_long=null`, в журнал пишется событие `legacy_dose_used` |
| TP-05 | Конфликт | `insulin_short=4`, `dose=7` | Сохраняется `insulin_short=4`, в телеметрии фиксируется конфликт |
| TP-06 | Нулевые значения | `insulin_short=0` | Запись сохраняется как `null`, UI выводит «не вводился» |
| TP-07 | Валидация | `insulin_long=-1` | Ошибка `422` |

## Дымовые проверки
1. После миграции выполнить `GET /api/entries` и убедиться, что новые поля присутствуют в JSON.
2. Через WebApp создать запись с обоими полями, проверить отображение в боте.
3. Проверить, что отчётность использует раздельные значения (см. [гайд](../reporting/insulin-doses-rendering.md)).

## Регрессия
- Повторить базовые сценарии напоминаний, чтобы убедиться в корректных текстах (см. [копирайтинг](../content/style/insulin-doses-copy.md)).
- Убедиться, что экспорты CSV не ломаются и содержат новые колонки (если поддерживаются).

## Данные и подготовка
- Использовать тестового пользователя с существующими записями `dose` для проверки обратной совместимости.
- Создать второго пользователя для чистых записей с двумя полями.
- Подготовить фикстуру в Postman/Insomnia для сценариев TP-01…TP-05.

## Метрики релиза
- QA мониторит события из [набора телеметрии](../observability/split-insulin-doses-metrics.md).
- Если `legacy_dose_used` превышает целевой порог, эскалировать владельцу продукта.
