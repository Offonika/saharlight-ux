# Тест-план: разделённые дозы инсулина

## Цели
Убедиться, что дневник, API и связанные сервисы корректно работают с отдельными полями `insulin_short` и `insulin_long`, а сценарии с легаси-полем `dose` обрабатываются без потери данных и нарушений бизнес-правил.

## Ссылки и артефакты
- [DoD Master — Split Insulin Doses](../feature-dod/split-insulin-doses.md)
- [MIGRATIONS — Split Insulin Doses](../MIGRATIONS.md#split-insulin-doses)
- [Reporting spec — визуализация доз](../reporting/insulin-doses-rendering.md)
- [UX copy](../content/style/insulin-doses-copy.md)

## Матрица тестовых сценариев

### Позитивные кейсы
| ID | Тип данных | Вход | Ожидаемый результат |
|----|------------|------|---------------------|
| TP-01 | Только короткий | `insulin_short=4.5`, `insulin_long` не передаётся | Ответ содержит `insulin_short=4.5`, `insulin_long=null`, UI помечает «короткий» |
| TP-02 | Только длинный | `insulin_long=8`, `insulin_short` не передаётся | Ответ содержит `insulin_long=8`, `insulin_short=null`, UI помечает «длинный» |
| TP-03 | Оба поля | `insulin_short=3`, `insulin_long=12` | Оба значения сохраняются и отображаются раздельно во всех клиентах |
| TP-04 | Легаси поле | `dose=6` | Значение мапится в `insulin_short=6`, `insulin_long=null`, телеметрия фиксирует `legacy_dose_used` |

### Негативные кейсы
| ID | Сценарий | Вход | Ожидаемый результат |
|----|----------|------|---------------------|
| TN-01 | Несоответствие единиц | `insulin_short="4 XE"` | Ошибка `422`, сообщение о неверных единицах |
| TN-02 | Отрицательное значение | `insulin_long=-1` | Ошибка `422`, поле подсвечивается как некорректное |
| TN-03 | Завышенное значение | `insulin_short=200` | Ошибка `422`, сообщение о превышении максимально допустимого значения |
| TN-04 | Пустые поля | `insulin_short=""`, `insulin_long=""`, `dose=""` | Ошибка валидации, пользователь получает подсказку о необходимости заполнения хотя бы одного поля |
| TN-05 | Конфликт легаси и новых полей | `insulin_short=4`, `dose=7` | Новое значение сохраняется, фиксируется событие конфликта, пользователю показывается предупреждение |

## Дымовые проверки после миграции
1. Подготовить до-миграционные данные с заполненным полем `dose` (экспорт из продакшн-бэкапа или подготовленные фикстуры).
2. Выполнить миграцию, описанную в [MIGRATIONS](../MIGRATIONS.md#split-insulin-doses).
3. Провести пост-миграционные проверки:
   - `GET /api/entries` возвращает записи, где исторические дозы сконвертированы в `insulin_short`/`insulin_long`.
   - Создание новой записи с обоими полями через WebApp сохраняет значения и отображается в боте корректно.
   - Телеметрия и отчётность используют раздельные значения в соответствии с [DoD Master](../feature-dod/split-insulin-doses.md).

## Регрессия
- Повторить базовые сценарии напоминаний и уведомлений, чтобы убедиться в корректных текстах (см. [копирайтинг](../content/style/insulin-doses-copy.md)).
- Проверить отчётность и экспорт данных, что новые колонки присутствуют и заполняются.

## Данные и подготовка
- Тестовый пользователь с историческими записями `dose` для проверки обратной совместимости.
- Второй пользователь для чистых записей с двумя полями.
- Фикстуры/коллекции Postman или Insomnia для сценариев TP-01…TP-04 и TN-01…TN-05.

## Метрики релиза
- QA мониторит события из [набора телеметрии](../observability/split-insulin-doses-metrics.md).
- Если `legacy_dose_used` превышает целевой порог, эскалировать владельцу продукта.
