# Свободный GPT-диалог: задачи на исправление

## Контекст
- Свободный хендлер сейчас продолжает работать как дневниковый парсер и отвечает "Не понял...", если GPT-парсер вернул действие, отличное от `add_entry`, даже когда пользователь выбрал режим «Чат». 【F:services/api/app/diabetes/handlers/gpt_handlers.py†L484-L493】
- Меню ассистента при выборе "Свободный диалог" только записывает `assistant_awaiting_kind`, но не активирует `gpt_mode`, поэтому `freeform_handler` не переключается в `chat_with_gpt`. 【F:services/api/app/diabetes/handlers/assistant_menu.py†L154-L169】【F:services/api/app/diabetes/handlers/gpt_handlers.py†L615-L688】
- Роутер ассистента перенаправляет текст в `freeform_handler`, где и происходит блокирующий ответ. 【F:services/api/app/diabetes/handlers/assistant_router.py†L58-L74】

## Задачи

### 1. Синхронизировать меню ассистента с GPT-режимом
- При обработке `asst:chat` активировать тот же сценарий, что и `/gpt`: очистить `mode_disclaimed`, выставить `gpt_mode`, запланировать таймаут и отправить приветственное сообщение. Можно вынести общую логику из `registration.start_gpt_dialog` в отдельный helper, чтобы избежать дублирования.
- При переключении на другие режимы (`learn`, `labs`, `visit`) и при возврате в меню явно сбрасывать `gpt_mode`/`mode_disclaimed`, чтобы дневниковый ввод снова работал в прежнем сценарии.
- Убедиться, что повторный выбор "Свободный диалог" обновляет таймаут и не создает дубликатов задач в `JobQueue`.

### 2. Обновить маршрутизацию свободного текста
- В `freeform_handler` учитывать, что режим "Чат" может быть активирован через `assistant_last_mode`: если пользователь в режиме чата, сообщения должны направляться в `chat_with_gpt` даже при отсутствии `gpt_mode`.
- Добавить защиту от «Не понял...» внутри GPT-режима: если парсер вернул другое действие или `None`, но текущий режим — чат, нужно продолжать диалог (например, напрямую вызывать `chat_with_gpt`).
- Проверить, что ответы `send_report` и другие дневниковые сценарии по-прежнему доступны, когда пользователь не в GPT-режиме.

### 3. Покрыть регрессию тестами
- Дополнить тесты `tests/test_gpt_mode.py` сценарием с выбором "Свободный диалог" через `assistant_menu`, проверив, что `freeform_handler` вызывает `chat_with_gpt` и не трогает дневниковый парсер.
- Добавить юнит-тест на поведение `freeform_handler`, когда GPT-парсер возвращает `{"action": "get_day_summary"}` при активном чат-режиме: бот должен продолжить диалог, а не отвечать шаблоном «Не понял».
- При необходимости замокать `JobQueue`, чтобы убедиться: при повторном входе в чат старая задача таймаута снимается, а новая добавляется.

## Дополнительные замечания
- Обновить документацию `/help` или подсказки в меню, если текст приветствия в чат-режиме поменяется.
- После исправлений убедиться, что `assistant_mode_total` продолжает инкрементироваться для режима `chat` без двойного счётчика.
