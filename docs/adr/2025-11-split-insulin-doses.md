# Split Insulin Doses (bolus/basal)

- **Дата:** 2025-11-12
- **Статус:** Draft
- **Владелец:** Backend Guild
- **Зависимости:** завершение задачи 1 (миграции и контракт API подготовлены)

## Контекст/Проблема
- Исторически дневник хранит единое поле `dose`, что скрывает различия между болюсными и базальными дозами.
- Новые сценарии (напоминания, аналитика, экспорт) требуют явного разделения доз, описанного в [DoD Master](../feature-dod/split-insulin-doses.md).
- Миграции и API-драфт из задачи 1 готовы, но без архитектурного решения команда не может синхронизировать реализацию, QA и метрики.

## Решение
- Принять двухкомпонентную модель доз с полями `insulin_short` (болюс) и `insulin_long` (базал), сохранив `dose` как легаси-алиас до полного вывода из эксплуатации.
- Все новые API-ручки и сценарии бота работают только с `insulin_short`/`insulin_long`; поле `dose` допускается лишь во входящих запросах для обратной совместимости (см. [API draft](../api/entries.md)).
- Бизнес-правила, тесты и UX-кейсы выравниваются по чек-листу [DoD Master](../feature-dod/split-insulin-doses.md) с обязательным покрытием негативных сценариев.
- Командам данных и миграций следовать пайплайну из [MIGRATIONS.md](../MIGRATIONS.md); финальная схема фиксируется в документации, а удаление `dose` выносится в отдельный релизный инкремент.

## Backfill-стратегия
- Легаси-записи, в которых присутствует только поле `dose`, трактуются как `insulin_short` при чтении и записи.
- При backfill-скриптах и ETL запрещено массовое копирование `dose` → `insulin_short`: сервер выполняет преобразование на лету, а отсутствующие `insulin_long` остаются `NULL`.
- Для аналитики и отчетности данные маркируются событием `legacy_dose_used`, что позволит мониторить долю непереведённых клиентов.

## Совместимость
- Старые клиенты продолжают отправлять `dose`; адаптер в API сохраняет совместимость, возвращая оба новых поля в ответах.
- Экспорт, уведомления и отчётность должны отображать два поля; при отсутствии `insulin_long` UI показывает «—» или «нет данных».
- Отчёты и история используют правила визуализации из [Reporting spec](../reporting/insulin-doses-rendering.md#правила-отображения); любые отклонения фиксируются отдельным RFC.
- Интеграции, использующие SDK, получают предупреждение о депрекации `dose` через телеметрию и changelog; дата удаления фиксируется в релиз-плане.

## Риски
- Возможны рассинхроны между клиентами и бэкендом, если клиенты некорректно обрабатывают `null` в `insulin_long`.
- Сценарии автоматического ввода могут продолжить присылать только `dose`, увеличивая нагрузку на адаптер и усложняя мониторинг.
- Ошибки в миграциях или backfill могут повредить аудит записей, если нарушить запрет на массовое обновление.

## Не-цели
- Удаление поля `dose` и связанных с ним адаптеров — отдельная инициатива после стабилизации метрик.
- Изменения UI/UX за пределами split-dose сценариев (например, настройки напоминаний) не входят в этот ADR.
- Автоматическая реконструкция базальных доз на основании болюсных значений не рассматривается.

## Rollback high-level
1. Зафиксировать текущие ревизии Alembic и применённые конфигурации перед релизом (см. [MIGRATIONS.md](../MIGRATIONS.md)).
2. При критическом инциденте выполнить `downgrade` до ревизии до split-dose и отключить фичетоггл в ботах, переключив клиентов на режим `dose`.
3. Очистить кэши и очередь напоминаний, восстановить телеметрию, убедиться, что legacy-клиенты снова получают корректные ответы API.
4. Провести постмортем и сверить чек-листы из [DoD Master](../feature-dod/split-insulin-doses.md) для повторного запуска.
