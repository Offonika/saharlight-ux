# Entries — поля и совместимость (draft)

Документ фиксирует переход дневника доз на два отдельных поля инсулина. `/entries` ещё не описан в OpenAPI, поэтому правила ниже — обязательный контракт для клиентов и серверных адаптеров.

## Поля записи
| Поле | Тип | Nullable | Описание |
|------|-----|----------|----------|
| `id` | UUID | нет | Идентификатор записи. |
| `timestamp` | ISO 8601 string | нет | Временная метка события в UTC. |
| `insulin_short` | number (0.0–200.0, шаг 0.5) | да | Краткодействующий болюс. `null` означает, что болюс не фиксировался в этой записи. |
| `insulin_long` | number (0.0–200.0, шаг 0.5) | да | Длительный базальный инсулин. `null` — нет базальной дозы. |
| `dose` | number | да | Легаси-поле записи. Принимается во входящих запросах, но не возвращается в ответах. |
| `notes` | string | да | Произвольная заметка пользователя; отсутствует или `null`, если комментарий не задан. |

> **Nullable-поведение.** Клиенты могут передавать только те поля, которые известны. Сервер сохраняет отсутствующее значение как `null` и всегда возвращает его явно в ответе, чтобы не приходилось угадывать наличие поля по структуре объекта.

## Совместимость с `dose`
- Если во входящем JSON есть только поле `dose`, оно трактуется как значение `insulin_short`, а `insulin_long` остаётся `null`.
- При одновременной передаче `dose` и `insulin_short` приоритет у `insulin_short`; значение `dose` игнорируется (можно логировать как легаси-вызов).
- Ответы API никогда не содержат поле `dose`. Клиент всегда получает явные `insulin_short` и `insulin_long` с числом или `null`.

## Примеры запросов и ответов

### Создание записи с болюсом
`POST /api/entries`

```json
{
  "timestamp": "2025-02-20T08:30:00Z",
  "insulin_short": 4.5
}
```

Ответ:

```json
{
  "id": "8f8f4d78-6be2-4b92-af83-7458f6ca2a93",
  "timestamp": "2025-02-20T08:30:00Z",
  "insulin_short": 4.5,
  "insulin_long": null,
  "notes": null
}
```

### Создание комбинированной дозы
```json
{
  "timestamp": "2025-02-20T22:00:00Z",
  "insulin_short": 2,
  "insulin_long": 12,
  "notes": "Ужин"
}
```

Ответ аналогичен по структуре: оба поля присутствуют, а `insulin_short` и `insulin_long` содержат переданные значения.

### Легаси-запрос с `dose`
```json
{
  "timestamp": "2025-02-20T08:30:00Z",
  "dose": 3
}
```

Ответ:

```json
{
  "id": "2b1dbca1-2eb8-4a21-8fbe-cf23655dd2fd",
  "timestamp": "2025-02-20T08:30:00Z",
  "insulin_short": 3,
  "insulin_long": null,
  "notes": null
}
```

## Обновление записи
`PATCH /api/entries/{id}` принимает частичные payload'ы. Например, добавляем базальную часть после подтверждения врача:

```json
{
  "insulin_long": 10
}
```

Ответ возвращает полную запись, в том числе неизменившиеся поля, чтобы клиенты всегда работали с единой структурой.

## Получение списка записей
`GET /api/entries?date=2025-02-20`

```json
[
  {
    "id": "f9416c67-6a1e-48b1-92d4-e838f9cbd6f9",
    "timestamp": "2025-02-20T07:00:00Z",
    "insulin_short": null,
    "insulin_long": 14,
    "notes": null
  },
  {
    "id": "8f8f4d78-6be2-4b92-af83-7458f6ca2a93",
    "timestamp": "2025-02-20T08:30:00Z",
    "insulin_short": 4.5,
    "insulin_long": null,
    "notes": "После завтрака"
  }
]
```

Любое отсутствующее значение отдаётся как `null`. Клиентам не нужно интерпретировать пропавшие ключи.

## Валидация и ошибки
- Диапазон значений по каждому полю `insulin_*` — от `0` до `200` единиц с шагом `0.5`. Нарушение — `422 Unprocessable Entity`.
- Значения округляются до ближайшего допустимого шага, если клиент передал `0.1`, `0.2` и т.д.
- `timestamp` обязателен во всех сценариях, включая легаси-передачу `dose`.
