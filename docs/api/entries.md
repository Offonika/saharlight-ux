# Entries API (draft)

Документ описывает работу с дневником записей по инсулину и сахару. `/entries` пока не формализован в OpenAPI, поэтому фиксируем
основные правила до синхронизации спецификации.

## Поля записи
| Поле | Тип | Nullable | Описание |
|------|-----|----------|----------|
| `id` | UUID | нет | Идентификатор записи |
| `timestamp` | ISO 8601 string | нет | Временная метка события |
| `insulin_short` | number (0.0–200.0, шаг 0.5) | да | Болюсный инсулин (короткий) |
| `insulin_long` | number (0.0–200.0, шаг 0.5) | да | Базальный инсулин (длинный) |
| `dose` | number | да | Легаси-поле, трактуется как `insulin_short` |
| `notes` | string | да | Текстовые заметки пользователя |

> ⚠️ Приём поля `dose` оставлен для обратной совместимости. Сервер сохраняет его как `insulin_short` и в ответе всегда отдаёт оба
> явных поля. Клиентам следует переходить на `insulin_short`/`insulin_long`.

## Создание записи
`POST /api/entries`

Минимальный запрос c краткодействующим инсулином:
```json
{
  "timestamp": "2025-02-20T08:30:00Z",
  "insulin_short": 4.5
}
```

Ответ:
```json
{
  "id": "8f8f4d78-6be2-4b92-af83-7458f6ca2a93",
  "timestamp": "2025-02-20T08:30:00Z",
  "insulin_short": 4.5,
  "insulin_long": null
}
```

Пример с легаси-полем `dose`:
```json
{
  "timestamp": "2025-02-20T08:30:00Z",
  "dose": 3
}
```

Ответ будет содержать `insulin_short: 3` и `insulin_long: null`. При одновременной передаче `dose` и `insulin_short` сервер использует
значение `insulin_short`, а `dose` записывается в телеметрию как легаси-вызов.

## Обновление записи
`PATCH /api/entries/{id}`

Поддерживаются частичные обновления. Пример добавления базального инсулина:
```json
{
  "insulin_long": 10
}
```

Сервер возвращает полную запись с обоими полями, даже если передан только один атрибут.

## Получение списка
`GET /api/entries?date=2025-02-20`

Ответ содержит массив записей. Каждая запись возвращает оба поля `insulin_short` и `insulin_long`. Если значения отсутствуют,
возвращается `null`. Клиентам не требуется суммировать поля — аналитика выполняется на бэкенде (см. [отчётность](../reporting/insulin-doses-rendering.md)).

## Валидация и ошибки
- Значения меньше `0` или больше `200` — ошибка `422 Unprocessable Entity`.
- Погрешность `0.1` округляется до ближайшего шага `0.5`.
- При попытке передать `dose` без `timestamp` сервер вернёт ошибку так же, как и для новых полей.
