# Телеметрия релиза: split insulin doses

> [← Назад к оглавлению документации](../README.md)

Документ описывает, какие события и метрики собираем для релиза раздельного ввода короткого и длинного инсулина, какие графики строим и какие алерты включаем.

## События и параметры
| Событие | Когда шлём | Обязательные параметры | Дополнительные теги | Назначение |
|---------|------------|------------------------|---------------------|------------|
| `entry_insulin_short_set` | Пользователь сохранил запись с полем `insulin_short` (создание/редактирование) | `value` (число Ед), `source` (`webapp`/`bot`/`api`), `client_version` | `was_legacy` (bool, если пользователь ранее отправлял `dose`), `meal_type`, `timezone` | Отслеживаем внедрение короткого инсулина |
| `entry_insulin_long_set` | Сохранена запись с полем `insulin_long` | `value`, `source`, `client_version` | `was_legacy`, `meal_type`, `timezone` | Контролируем заполнение длинного инсулина |
| `legacy_dose_used` | Клиент отправил только старое поле `dose` | `value`, `source`, `client_version` | `reason` (если фронт передаёт), `timezone` | Отслеживаем пользователей, не перешедших на новый формат |

> Примечание: события должны уходить в Amplitude и ClickHouse. Название параметров — snake_case, значения `source` синхронизированы с существующим справочником в `event_sources`.

## Целевые графики
1. **Adoption short/long insulin** — суточное количество уникальных пользователей и записей по событиям `entry_insulin_short_set` и `entry_insulin_long_set`. Сегментация по `source` и `client_version`. Target: ≥ 70 % активных пользователей используют короткий инсулин на 7-й день релиза.
2. **Legacy share trend** — доля `legacy_dose_used` от суммы `entry_insulin_short_set + entry_insulin_long_set + legacy_dose_used` на 24-часовом окне. Target: ≤ 20 % через 3 дня после релиза, ≤ 10 % через 7 дней.
3. **Value distribution** — histogram/box-plot по `value` для короткого и длинного инсулина (отдельные графики) с фильтром по `source`, чтобы увидеть смещения и аномалии.
4. **Editing loop** — количество повторных изменений (где в течение 15 минут есть два события `entry_insulin_short_set`/`entry_insulin_long_set` с одинаковым `entry_id`). Используем как индикатор UX-проблем; фиксируем baseline < 5 %.

## Алерты и пороги
| Алерт | Условие | Канал | Комментарий |
|-------|---------|-------|-------------|
| `legacy_dose_share_high` | `legacy_dose_used` share > 25 % (24h rolling) спустя 48 часов после релиза | #diabetes-product, OpsGenie (P2) | Сигнал, что пользователи не переходят на новый ввод |
| `missing_long_entries` | 0 событий `entry_insulin_long_set` в течение 6 часов (rolling) | #diabetes-backend, OpsGenie (P1) | Возможный регресс или ломка формы |
| `short_vs_long_ratio` | Соотношение `entry_insulin_short_set / entry_insulin_long_set` < 0.4 или > 2.5 за сутки | #diabetes-analytics | Нотификация для проверки корректности подсказок UX |
| `event_ingestion_drop` | Падение общего числа событий ниже 60 % от среднего последних 7 дней | #observability | Проверяем пайплайн событий |

Алерты настраиваются в Grafana (источник ClickHouse) + OpsGenie. Необходимо добавить runbook-ссылки в OpsGenie с контактами on-call.

## Чек-лист мониторинга первые 72 часа
1. **T-0 (момент выката):**
   - Проверить, что все три события появляются в ClickHouse и Amplitude (по тестовым пользователям).
   - Убедиться, что алерты переведены в статус «Enabled».
   - Задокументировать ссылку на дашборд в DoD Master.
2. **+12 часов:**
   - Аналитик проверяет график Adoption short/long; ожидаем ≥ 30 % пользователей с коротким инсулином.
   - Сравниваем долю legacy с предыдущими сутками, фиксируем в Slack-треде релиза.
3. **+24 часа:**
   - Дежурный бэкендер проверяет лог OpsGenie (нет ли false positive).
   - QA делает спот-чек значений `value` (нет ли отрицательных/аномально высоких значений).
4. **+48 часов:**
   - Продукт-менеджер подтверждает достижение цели legacy share ≤ 25 %.
   - Аналитик делает выгрузку ratio короткий/длинный, сверяет с ожиданиями.
5. **+72 часа:**
   - Команда синхронизируется: фиксируем итоговые цифры adoption/legacy в DoD Master.
   - Принимаем решение, оставляем ли усиленный мониторинг или переводим в стандартный режим.

## Дальнейшие шаги
- После стабилизации (legacy share < 5 % в течение 14 дней) запланировать удаление события `legacy_dose_used` и старого поля `dose`.
- Рассмотреть создание когорты пользователей с длительным использованием legacy и провести интервью.
