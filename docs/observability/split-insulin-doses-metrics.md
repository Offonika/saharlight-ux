# Телеметрия: split insulin doses

Документ описывает метрики и алёрты для фичи разделения доз инсулина.

## События
| Событие | Когда отправляется | Поля |
|---------|-------------------|------|
| `entry_insulin_short_set` | Запись создана/обновлена с `insulin_short` | `value` (число), `source` (`webapp`/`bot`/`api`), `was_legacy` (bool) |
| `entry_insulin_long_set` | Запись создана/обновлена с `insulin_long` | `value`, `source` |
| `legacy_dose_used` | Клиент прислал только `dose` | `value`, `client_version`, `source` |

## Дашборд
- Графики распределения по значениям `insulin_short` и `insulin_long` (дневная агреграция).
- Виджет «Legacy share» = `legacy_dose_used` / (`entry_insulin_short_set` + `entry_insulin_long_set`).
- Таблица «Конфликтные запросы» — события, где пришёл и `dose`, и новые поля.

## Алёрты
- **legacy_dose_used_high**: если доля legacy-событий > 15% в течение 6 часов, уведомить #diabetes-product.
- **missing_long_entries**: если 0 событий `entry_insulin_long_set` за 24 часа, проверить ввод базального инсулина (возможно, клиент не отправляет поле).

## Чек-лист релиза
1. Настроить источники в Amplitude/ClickHouse до выкатки.
2. Добавить алёрты в OpsGenie с ответственными из бэкенд-команды.
3. В первые 72 часа после релиза:
   - Дежурный бэкендер проверяет дашборд каждые 6 часов.
   - Продукт-менеджер подтверждает снижение `legacy_dose_used` до < 10%.
   - QA фиксирует выводы в тест-плане (см. [QA документ](../qa/split-insulin-doses-testplan.md)).

## Дальнейшие шаги
- После стабилизации удалить событие `legacy_dose_used` вместе с полем `dose`.
- Рассмотреть добавление метрик по частоте правок уже созданных записей для оценки UX.
