# Split Insulin Doses — Definition of Done

> Данный чек-лист фиксирует единый источник истины о готовности функциональности по разбиению доз инсулина.
>
> Ссылки на исходные артефакты: [ADR 005 — Split insulin doses](../ADR/005-split-insulin-doses.md), [MIGRATIONS.md](../MIGRATIONS.md), [API draft — diary entries](../api/entries.md), [UX copy](../content/style/insulin-doses-copy.md), [Reporting spec](../reporting/insulin-doses-rendering.md), [QA test plan](../qa/split-insulin-doses-testplan.md), [Observability checklist](../observability/split-insulin-doses-metrics.md).

## Архитектура и данные
**Готово, если…**
- [ ] диаграммы и описания в архитектурных документах обновлены по [ADR 005 — Split insulin doses](../ADR/005-split-insulin-doses.md);
- [ ] схема БД и миграции соответствуют требованиям раздела [Split Insulin Doses](../MIGRATIONS.md#split-insulin-doses), новые индексы и связи покрыты описанием;
- [ ] все сервисы и фоновые джобы корректно читают и сохраняют поля `insulin_short` и `insulin_long` в новом формате сплит-доз.

**Негативные кейсы**
- [ ] отсутствуют расхождения между фактической схемой и документацией, которые ломают миграции или деплой;
- [ ] не возникает несогласованности данных при откате миграций или повторном прогоне мигратора;
- [ ] не появляются гонки или deadlock'и при параллельной записи доз.

## Ввод/Парсинг
**Готово, если…**
- [ ] парсинг сообщений пользователя покрывает значения «быстрая», «длинная», комбинированные дозы и сокращения из [UX copy](../content/style/insulin-doses-copy.md);
- [ ] добавлены валидации на несогласованные значения (например, сумма частей, отрицательные числа, пустые поля);
- [ ] обработаны единицы измерения, округления и ограничения, описанные в API и UX.

**Негативные кейсы**
- [ ] некорректные форматы (текст, эмодзи, голосовые) не приводят к падениям — бот выдаёт понятную подсказку;
- [ ] сообщения с несовместимыми значениями (например, два раза «быстрая» без «длинной») отклоняются и логируются;
- [ ] отсутствуют silent failure при ошибке парсинга (пользователь всегда получает ответ).

## Сценарии (pending/quick/GPT)
**Готово, если…**
- [ ] сценарии «pending dose», «quick add» и GPT-режим отражают новую модель доз и используют единый источник бизнес-логики;
- [ ] fallback-ответы GPT проверены на соответствие [API draft](../api/entries.md) и UX copy;
- [ ] состояние wizard'ов сбрасывается корректно после подтверждения или отмены дозы.

**Негативные кейсы**
- [ ] GPT не выдаёт рекомендации, выходящие за пределы безопасных диапазонов;
- [ ] режим «pending» не зависает при потере соединения или перезапуске бота;
- [ ] «quick add» не дублирует дозу при повторном нажатии или повторной доставке апдейта.

## Отчёты/История
**Готово, если…**
- [ ] отчёты и история в WebApp и Telegram учитывают обе части дозы и отображают их согласно [Reporting spec](../reporting/insulin-doses-rendering.md);
- [ ] экспортные форматы (CSV, PDF) и API-эндпоинты содержат корректные поля сплит-доз;
- [ ] аналитика и агрегаты (суточные/недельные) пересчитаны и проверены.

**Негативные кейсы**
- [ ] нет расхождений между отчётом и фактическими данными в БД;
- [ ] система не падает при запросе истории с legacy-записями без сплит-доз;
- [ ] не возникает утечек PII при выгрузке комбинированных отчётов.

## Напоминания
**Готово, если…**
- [ ] напоминания учитывают раздельные дозы и корректно подсказывают пользователю, когда принять каждую часть;
- [ ] логика snooze/skip обновлена и покрыта тестами на новые статусы;
- [ ] push и Telegram-уведомления используют копирайтинг из [UX copy](../content/style/insulin-doses-copy.md).

**Негативные кейсы**
- [ ] напоминания не дублируются и не пропадают при смене часового пояса;
- [ ] пропущенные дозы корректно логируются и отражаются в отчётах;
- [ ] пользователь не получает уведомления для отменённой дозы.

## Совместимость/Ошибки
**Готово, если…**
- [ ] backward-совместимость обеспечена: старые клиенты продолжают работать через адаптеры и миграцию данных;
- [ ] ошибки парсинга/валидации логируются и выводятся в алёрты из [Observability checklist](../observability/split-insulin-doses-metrics.md);
- [ ] API возвращает структурированные ошибки с кодами и подсказками.

**Негативные кейсы**
- [ ] не возникает HTTP 500/telegram-ошибок в публичных ручках;
- [ ] адаптеры не ломают клиентов без обновления;
- [ ] интеграции (например, экспорт в EHR) не получают некорректный payload.

## Тесты
**Готово, если…**
- [ ] unit-, интеграционные и end-to-end тесты покрывают happy-path и крайние случаи из [QA test plan](../qa/split-insulin-doses-testplan.md);
- [ ] добавлены регрессионные тесты для legacy-сценариев ввода доз;
- [ ] измеряется и поддерживается покрытие не ниже 85 % для затронутых модулей.

**Негативные кейсы**
- [ ] тесты падают при нарушении инвариантов (например, сумма частей не совпадает) и блокируют релиз;
- [ ] flaky-тесты задокументированы и устранены;
- [ ] нет «тихих» пропусков тестов из-за неправильных меток или зависимостей.

## Документация/Релиз
**Готово, если…**
- [ ] README, release notes и onboarding-материалы описывают новую модель доз;
- [ ] релизный чек-лист синхронизирован с [Observability checklist](../observability/split-insulin-doses-metrics.md) и миграциями;
- [ ] инструкции по поддержке обновлены для команды саппорта.

**Негативные кейсы**
- [ ] нет рассинхрона между русской и английской документацией;
- [ ] релиз не стартует без подтверждённых миграций и оповещений;
- [ ] отсутствуют устаревшие скриншоты или тексты в FAQ/лендингах.

## Откат
**Готово, если…**
- [ ] описан пошаговый план отката: открепление миграций, перевод напоминаний, очистка кэшей;
- [ ] подготовлены скрипты/анзибл-плейбуки для быстрой деактивации сплит-доз;
- [ ] мониторинг отката опирается на метрики из [Observability checklist](../observability/split-insulin-doses-metrics.md).

**Негативные кейсы**
- [ ] откат не приводит к потере истории доз или уведомлений;
- [ ] нет ситуаций, когда старые клиенты ломаются после возврата к прежней схеме;
- [ ] постмортем-шаблон заполнен при любом аварийном откате.
