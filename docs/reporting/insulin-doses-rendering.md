# Отчётность: визуализация раздельных доз инсулина

Документ описывает единые правила отображения дневника, сводных отчётов и экспортов после перехода на поля `insulin_short` и `insulin_long`.

## Правила отображения
- Всегда показывайте «Короткий» и «Длинный» как две отдельные строки/столбца. Значения не суммируются и не сводятся в общий показатель.
- Для чисел используйте формат `X ед.` без лишних нулей (`2`, `2.5`, `2.75`).
- При отсутствии значения выводите `—` и вторую строку оставляйте на месте, чтобы не ломать визуальный ритм карточки.
- Если в записи присутствует `legacy_dose`, подписывайте короткий инсулин как «Короткий (legacy)» и выводите значение `dose` без перерасчёта. Длинный остаётся `—`.
- Комментарии, заметки и метки (например, «⚠ ночная корректировка») отображаются под блоком доз и не влияют на порядок полей.

### Примеры блоков истории
```
13:45  •  Пицца
Короткий: 6 ед.
Длинный: 10 ед.

21:10  •  Коррекция глюкозы
Короткий: 4 ед.
Длинный: —
Комментарий: «Снизил по рекомендации врача»

08:05  •  Legacy (старый клиент)
Короткий (legacy): 7 ед.
Длинный: —
Подсказка: «Обновите приложение, чтобы вносить длинный инсулин отдельно»
```

### Поведение при частично заполненных полях
| `insulin_short` | `insulin_long` | `dose` | Отображение короткого | Отображение длинного | Дополнительно |
| --- | --- | --- | --- | --- | --- |
| значение | значение | пусто | `Короткий: {insulin_short}` | `Длинный: {insulin_long}` | — |
| значение | `NULL` | пусто | `Короткий: {insulin_short}` | `Длинный: —` | — |
| `NULL` | значение | пусто | `Короткий: —` | `Длинный: {insulin_long}` | выделите предупреждение в аналитике (запись требует backfill) |
| `NULL` | `NULL` | значение | `Короткий (legacy): {dose}` | `Длинный: —` | показывать подсказку об устаревшем формате |
| значение | `NULL` | значение | использовать `insulin_short`; `dose` переносим в подсказку «поле будет удалено» | `Длинный: —` | логируйте метку `legacy_dose_used=true` |
| `NULL` | значение | значение | `Короткий (legacy): {dose}` | `Длинный: {insulin_long}` | дополнительно подсвечивайте запись в отчёте для проверки |

## Сводные отчёты и экспорт
- В суточных/недельных таблицах добавляйте два независимых столбца: `Итого короткий`, `Итого длинный`. Общие суммы запрещены.
- Графики строятся отдельно: одна серия для `insulin_short`, другая для `insulin_long`. Для legacy доз точки в длинном графике пропускаются.
- Экспорт CSV/PDF содержит колонки `insulin_short`, `insulin_long`, `legacy_dose` (fallback). При экспорте в сторонние системы колонка `legacy_dose` помечается как deprecated.
- KPI и алерты опираются на долю пустых значений в каждом столбце отдельно; смешение данных между полями запрещено.

## Логирование и телеметрия
- Каждую запись с использованием `dose` помечайте флагом `legacy_dose_used` для дальнейшего мониторинга (см. ADR).
- Сервис отчётов должен отправлять метрику `reporting.doses.missing_long` и `reporting.doses.missing_short` при выводе `—`.
- Любые преобразования значений (например, округление) фиксируются в changelog и требуют согласования с владельцем DoD Master.

## Согласования и источники
- Копирайтинг и подписи уточняйте по документу [UX copy для доз](../content/style/insulin-doses-copy.md).
- Чек-лист готовности: [DoD Master — Split Insulin Doses](../feature-dod/split-insulin-doses.md#отчётыистория).
- Архитектурные ограничения и поведение legacy записей описаны в [ADR Split Insulin Doses](../adr/2025-11-split-insulin-doses.md#совместимость).
