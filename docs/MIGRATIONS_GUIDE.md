# üìú MIGRATIONS_GUIDE.md

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ **saharlight-ux**.  
–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∫ —Å–æ–±–ª—é–¥–µ–Ω–∏—é –∫–∞–∫ –∞–≥–µ–Ω—Ç–æ–º Codex, —Ç–∞–∫ –∏ –ª—é–±—ã–º –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–º.

---

## üóÇÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î –≤–Ω–æ—Å—è—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ **Alembic**.
- –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–≥–æ–µ:  
  `YYYYMMDD_<–æ–ø–∏—Å–∞–Ω–∏–µ>.py`  
  (–≥–¥–µ `YYYYMMDD` ‚Äî –¥–∞—Ç–∞ –ø–æ UTC, `<–æ–ø–∏—Å–∞–Ω–∏–µ>` ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ snake_case).
- –í–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞:
  - `revision` = –∏–º—è —Ñ–∞–π–ª–∞ (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä).
  - `down_revision` = –ø—Ä–µ–¥—ã–¥—É—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∏–ª–∏ merge-head.
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ –º–æ–¥–µ–ª—è—Ö (`models.py`).
- –í PR —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã.

---

## üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏:
   ```bash
   make migrate
–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–≤–∏–∑–∏—é:

bash
Copy code
alembic revision -m "–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª:

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å revision –∏ down_revision.

–í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ op.add_column, op.drop_column, op.create_foreign_key –∏ —Ç.–ø.

–î–ª—è ENUM –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ op.execute.

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

bash
Copy code
make migrate
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ—Å—Ç—ã –∏ –ª–∏–Ω—Ç–µ—Ä –ø—Ä–æ—Ö–æ–¥—è—Ç:

bash
Copy code
pytest
mypy --strict
ruff check .
üîÄ Merge heads
–ò–Ω–æ–≥–¥–∞ Alembic —Å–æ–æ–±—â–∞–µ—Ç –æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö ¬´–≥–æ–ª–æ–≤–∞—Ö¬ª (multiple heads).
–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å merge-–º–∏–≥—Ä–∞—Ü–∏—é:

bash
Copy code
alembic revision -m "merge heads" --head <head1> --head <head2>
–í —Ç–∞–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏—è—Ö –Ω–µ –ø–∏—à–µ–º SQL, —Ç–æ–ª—å–∫–æ —Å–≤—è–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é.

–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å revision, down_revision (–∫–æ—Ä—Ç–µ–∂ –∏–∑ heads).

üé≠ –†–∞–±–æ—Ç–∞ —Å ENUM
ENUM –≤ PostgreSQL ‚Äî —á–∞—Å—Ç—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–æ–∫. –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å ¬´DuplicateObject¬ª:

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏—Ç–µ CREATE TYPE –Ω–∞–ø—Ä—è–º—É—é –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö.

–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è ENUM –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ postgresql.ENUM –∏ op.alter_column.

–ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ subscription_plan:

python
Copy code
from sqlalchemy.dialects import postgresql

old_type = postgresql.ENUM('free', 'pro', name='subscription_plan')
new_type = postgresql.ENUM('free', 'pro', 'family', name='subscription_plan')

op.alter_column(
    'users',
    'plan',
    type_=new_type,
    existing_type=old_type,
    nullable=False,
    server_default='free',
)
üßπ Foreign Keys –∏ –∏–Ω–¥–µ–∫—Å—ã
–ü–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ FK –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω —É–∂–µ:

sql
Copy code
\d+ table_name
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ (ON DELETE CASCADE):

–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (op.drop_constraint).

–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ (op.create_foreign_key).

–ü—Ä–∏–º–µ—Ä:

python
Copy code
op.drop_constraint("lesson_logs_user_id_fkey", "lesson_logs", type_="foreignkey")
op.create_foreign_key(
    "lesson_logs_user_id_fkey",
    "lesson_logs",
    "users",
    ["user_id"],
    ["telegram_id"],
    ondelete="CASCADE",
)
üêõ –û—Ç–ª–∞–¥–∫–∞ –∏ –æ—à–∏–±–∫–∏
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
bash
Copy code
psql -d diabetes_bot -c "SELECT * FROM alembic_version;"
–û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
bash
Copy code
alembic downgrade -1
–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–∞–Ω–æ–≤–æ
bash
Copy code
alembic upgrade head
–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ë–î (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø–æ—á–∏–Ω–∏—Ç—å)
bash
Copy code
dropdb diabetes_bot && createdb diabetes_bot
make migrate
‚öôÔ∏è Codex –∏ CI
–ö–∞–∂–¥—ã–π PR —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –¥–æ–ª–∂–µ–Ω:

—É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å:

bash
Copy code
make migrate
–Ω–∞ —á–∏—Å—Ç–æ–π –±–∞–∑–µ,

—Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (alembic revision --autogenerate –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ),

–≤–∫–ª—é—á–∞—Ç—å —Ç–µ—Å—Ç—ã, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã/–∫–æ–ª–æ–Ω–∫–∏.

CI –ø—Ä–æ–≥–æ–Ω—è–µ—Ç:

bash
Copy code
pytest
mypy --strict
ruff check .
make migrate
‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ PR
 –ò–º—è —Ñ–∞–π–ª–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à–∞–±–ª–æ–Ω—É.

 revision —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞.

 down_revision –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π.

 –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ENUM –∏ FK.

 make migrate —É—Å–ø–µ—à–Ω–æ –Ω–∞ —á–∏—Å—Ç–æ–π –ë–î.

 –í—Å–µ —Ç–µ—Å—Ç—ã –∏ –ª–∏–Ω—Ç–µ—Ä –ø—Ä–æ—à–ª–∏.













