"""Handlers for managing emergency SOS contact information."""

from __future__ import annotations

import re

from telegram import Update
from telegram.ext import (
    CommandHandler,
    ContextTypes,
    ConversationHandler,
    MessageHandler,
    filters,
)

from diabetes.db import SessionLocal, Profile
from diabetes.ui import back_keyboard, menu_keyboard
from .common_handlers import commit_session
from . import dose_handlers
from .dose_handlers import _cancel_then

SOS_CONTACT, = range(1)


async def sos_contact_start(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    """Prompt user to enter emergency contact."""
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –≤ Telegram (@username). –¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.",
        reply_markup=back_keyboard,
    )
    return SOS_CONTACT


def _is_valid_contact(text: str) -> bool:
    """Validate telegram username."""
    username = re.fullmatch(r"@[A-Za-z][A-Za-z0-9_]{4,31}", text)
    return bool(username)


async def sos_contact_save(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    """Save provided contact to profile."""
    contact = update.message.text.strip()
    if not _is_valid_contact(contact):
        await update.message.reply_text(
            "‚ùó –£–∫–∞–∂–∏—Ç–µ @username. –¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.",
            reply_markup=back_keyboard,
        )
        return SOS_CONTACT

    user_id = update.effective_user.id
    with SessionLocal() as session:
        profile = session.get(Profile, user_id)
        if not profile:
            profile = Profile(telegram_id=user_id)
            session.add(profile)
        profile.sos_contact = contact
        if not commit_session(session):
            await update.message.reply_text(
                "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç.",
                reply_markup=menu_keyboard,
            )
            return ConversationHandler.END

    await update.message.reply_text(
        "‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è SOS —Å–æ—Ö—Ä–∞–Ω—ë–Ω.",
        reply_markup=menu_keyboard,
    )
    return ConversationHandler.END


async def sos_contact_cancel(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    """Cancel SOS contact input."""
    await update.message.reply_text("–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=menu_keyboard)
    return ConversationHandler.END


sos_contact_conv = ConversationHandler(
    entry_points=[CommandHandler("soscontact", sos_contact_start)],
    states={SOS_CONTACT: [MessageHandler(filters.TEXT & ~filters.COMMAND, sos_contact_save)]},
    fallbacks=[
        MessageHandler(filters.Regex("^‚Ü©Ô∏è –ù–∞–∑–∞–¥$"), sos_contact_cancel),
        CommandHandler("cancel", sos_contact_cancel),
        MessageHandler(
            filters.Regex("^üì∑ –§–æ—Ç–æ –µ–¥—ã$"),
            _cancel_then(dose_handlers.photo_prompt),
        ),
    ],
    per_message=False,
)

__all__ = ["sos_contact_conv"]
